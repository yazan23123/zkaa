import React, { useState, useEffect } from 'react';
import { GoogleGenAI } from '@google/genai';
import { Category, Language } from '../types';
import { CopyIcon, SparklesIcon, BackIcon, ContentIcon } from './icons';
import { translations } from '../translations';

const LoadingSpinner: React.FC<{ text: string }> = ({ text }) => (
    <div className="flex items-center justify-center gap-2 text-indigo-300">
        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>{text}</span>
    </div>
);

interface IdeaGeneratorProps {
  category: Category;
  onBack: () => void;
  language: Language;
}

const IdeaGenerator: React.FC<IdeaGeneratorProps> = ({ category, onBack, language }) => {
  const t = translations[language];
  const [currentIdea, setCurrentIdea] = useState<string>('');
  const [usedIdeas, setUsedIdeas] = useState<Set<string>>(new Set());
  const [showToast, setShowToast] = useState<boolean>(false);
  const [key, setKey] = useState<number>(0);
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [expandedContent, setExpandedContent] = useState<string>('');
  const [error, setError] = useState<string>('');

  // Effect for generating the initial idea when the category or language changes.
  useEffect(() => {
    const allIdeas = category.ideas[language];
    if (!allIdeas || allIdeas.length === 0) {
        setCurrentIdea(t.noIdeasInCategory);
        setUsedIdeas(new Set());
        return;
    }

    const firstIdea = allIdeas[Math.floor(Math.random() * allIdeas.length)];
    setCurrentIdea(firstIdea);
    setUsedIdeas(new Set([firstIdea]));
    
    // Reset other states
    setExpandedContent('');
    setError('');
    setShowToast(false);
    setKey(prevKey => prevKey + 1); // Animate first idea
  }, [category, language]);


  const handleGenerateNewIdea = () => {
    setExpandedContent('');
    setError('');

    const allIdeas = category.ideas[language];
    
    let availableIdeas = allIdeas.filter(idea => !usedIdeas.has(idea));
    let newUsedIdeasSet = new Set(usedIdeas);

    // If all ideas have been used, reset the 'used' set and start over.
    if (availableIdeas.length === 0) {
        newUsedIdeasSet = new Set();
        availableIdeas = allIdeas;
    }

    // Select a random idea from the available pool
    const newIdea = availableIdeas[Math.floor(Math.random() * availableIdeas.length)];
    
    setCurrentIdea(newIdea);
    
    // Add the new idea to the set of used ideas for the next generation
    newUsedIdeasSet.add(newIdea);
    setUsedIdeas(newUsedIdeasSet);

    setKey(prevKey => prevKey + 1);
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    setShowToast(true);
    setTimeout(() => {
      setShowToast(false);
    }, 2000);
  };

  const handleExpandIdea = async () => {
    if (!currentIdea) return;
    setIsLoading(true);
    setExpandedContent('');
    setError('');

    try {
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
      const prompt = `
        أنت خبير في صناعة المحتوى لمنصة انستغرام. بالنظر إلى الفئة "${category.name['ar']}" والفكرة التالية: "${currentIdea}".

        قم بإنشاء خطة محتوى مفصلة ومبتكرة يمكن استخدامها لإنشاء فيديو ريلز (Instagram Reel).

        الخطة يجب أن تتضمن الأقسام التالية بوضوح:
        1. **عنوان جذاب (Hook):** جملة قصيرة لجذب الانتباه في أول 3 ثوانٍ.
        2. **السيناريو/الخطوات:** نص مقترح للفيديو، مقسم إلى مشاهد أو خطوات واضحة.
        3. **اقتراحات بصرية:** أفكار حول كيفية تصوير كل مشهد، الزوايا، والانتقالات.
        4. **نص إضافي (Overlay Text):** أي نصوص يمكن إضافتها على الفيديو للتوضيح.
        5. **صوت مقترح (Audio):** نوع الموسيقى أو الصوت الرائج (Trending Audio) الذي يناسب الفكرة.
        6. **الكابشن (Caption):** نص للكابشن يتضمن سؤالاً للتفاعل.
        7. **هاشتاجات:** 5 هاشتاجات ذات صلة.
      `;

      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: prompt,
      });

      setExpandedContent(response.text);

    } catch (e) {
      console.error(e);
      setError(t.errorGeneratingContent);
    } finally {
      setIsLoading(false);
    }
  };

  const CategoryIcon = category.icon;

  return (
    <div className="flex flex-col items-center w-full">
      {showToast && (
        <div className="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg animate-bounce z-50">
          {t.ideaCopiedToast}
        </div>
      )}

      <button
        onClick={onBack}
        className="self-start mb-8 flex items-center gap-2 text-indigo-300 hover:text-indigo-100 transition-colors duration-200"
        disabled={isLoading}
      >
        <BackIcon className="w-5 h-5" />
        <span>{t.backToCategories}</span>
      </button>

      <div className="w-full max-w-2xl bg-gray-800/60 backdrop-blur-md border border-gray-700/60 rounded-2xl p-6 md:p-10 text-center shadow-xl shadow-indigo-900/20">
        <div className="flex justify-center items-center gap-4 mb-6">
            <div className="flex items-center justify-center h-12 w-12 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600">
                <CategoryIcon className="h-7 w-7 text-white" />
            </div>
            <h2 className="text-3xl font-bold text-gray-100">{category.name[language]}</h2>
        </div>
        
        <div className="min-h-[120px] flex items-center justify-center p-4 my-6 bg-gray-900/50 rounded-lg border border-gray-700">
          <p key={key} className="text-2xl font-medium text-indigo-200 animate-fade-in">
            {currentIdea}
          </p>
        </div>

        <div className="flex flex-col sm:flex-row gap-4">
          <button
            onClick={() => copyToClipboard(currentIdea)}
            disabled={isLoading || !currentIdea}
            className="flex-1 flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <CopyIcon className="w-5 h-5" />
            <span>{t.copyIdea}</span>
          </button>
          <button
            onClick={handleGenerateNewIdea}
            disabled={isLoading}
            className="flex-1 flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <SparklesIcon className="w-5 h-5" />
            <span>{t.newIdea}</span>
          </button>
        </div>
         <div className="mt-4">
            <button
                onClick={handleExpandIdea}
                disabled={isLoading || !currentIdea}
                className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:scale-100"
            >
                <ContentIcon className="w-6 h-6" />
                <span>{t.expandIdea}</span>
            </button>
        </div>
      </div>
      
      <div className="w-full max-w-2xl mt-8">
        {isLoading && <LoadingSpinner text={t.generatingContent} />}
        {error && <p className="text-red-400 bg-red-900/50 border border-red-700 p-4 rounded-lg text-center">{error}</p>}
        {expandedContent && (
            <div className="bg-gray-800/40 backdrop-blur-md border border-gray-700/40 rounded-2xl p-6 md:p-8 text-right shadow-lg animate-fade-in">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-2xl font-bold text-indigo-200">{t.contentPlan}</h3>
                    <button 
                        onClick={() => copyToClipboard(expandedContent)}
                        className="flex items-center gap-2 text-gray-400 hover:text-white transition-colors p-2 rounded-md bg-gray-700/50 hover:bg-gray-700"
                        aria-label="نسخ خطة المحتوى"
                    >
                        <CopyIcon className="w-5 h-5" />
                        <span>{t.copyContent}</span>
                    </button>
                </div>
                <div className="prose prose-invert prose-p:text-gray-300 prose-headings:text-indigo-300 prose-strong:text-white whitespace-pre-wrap font-sans">
                    {expandedContent}
                </div>
            </div>
        )}
      </div>

      <style>{`
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.5s ease-in-out;
        }
        .prose {
            max-width: 100%;
        }
        html[dir="ltr"] .prose {
            text-align: left;
        }
        html[dir="rtl"] .prose {
            text-align: right;
        }
      `}</style>
    </div>
  );
};

export default IdeaGenerator;
